#include <sys/types.h>
#include <sys/ioctl.h>
#include <dev/iicbus/iic.h>

#include <stdio.h>
#include <string.h>
#include <errno.h>
#include <fcntl.h>
#include <unistd.h>

#define IICBUS	"/dev/iic1"
#define IICADDR	0x3c

#define SSD1306_LCDWIDTH  64
#define SSD1306_LCDHEIGHT 48

#define SSD1306_SETCONTRAST 0x81
#define SSD1306_DISPLAYALLON_RESUME 0xA4
#define SSD1306_DISPLAYALLON 0xA5
#define SSD1306_NORMALDISPLAY 0xA6
#define SSD1306_INVERTDISPLAY 0xA7
#define SSD1306_DISPLAYOFF 0xAE
#define SSD1306_DISPLAYON 0xAF

#define SSD1306_SETDISPLAYOFFSET 0xD3
#define SSD1306_SETCOMPINS 0xDA

#define SSD1306_SETVCOMDETECT 0xDB

#define SSD1306_SETDISPLAYCLOCKDIV 0xD5
#define SSD1306_SETPRECHARGE 0xD9

#define SSD1306_SETMULTIPLEX 0xA8

#define SSD1306_SETLOWCOLUMN 0x00
#define SSD1306_SETHIGHCOLUMN 0x10

#define SSD1306_SETSTARTLINE 0x40

#define SSD1306_MEMORYMODE 0x20
#define SSD1306_COLUMNADDR 0x21
#define SSD1306_PAGEADDR   0x22

#define SSD1306_COMSCANINC 0xC0
#define SSD1306_COMSCANDEC 0xC8

#define SSD1306_SEGREMAP 0xA0

#define SSD1306_CHARGEPUMP 0x8D

#define SSD1306_EXTERNALVCC 0x1
#define SSD1306_SWITCHCAPVCC 0x2

// Scrolling #defines
#define SSD1306_ACTIVATE_SCROLL 0x2F
#define SSD1306_DEACTIVATE_SCROLL 0x2E
#define SSD1306_SET_VERTICAL_SCROLL_AREA 0xA3
#define SSD1306_RIGHT_HORIZONTAL_SCROLL 0x26
#define SSD1306_LEFT_HORIZONTAL_SCROLL 0x27
#define SSD1306_VERTICAL_AND_RIGHT_HORIZONTAL_SCROLL 0x29
#define SSD1306_VERTICAL_AND_LEFT_HORIZONTAL_SCROLL 0x2A

/*
  static uint8_t buffer[SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8 + 1] = {0x40};
*/
static uint8_t buffer[SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8 + 1] = {
								       0x40,
								       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0,
								       0xE0, 0xF0, 0xF8, 0xFC, 0xFC, 0xFE, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8,
								       0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0x80, 0xC0, 0xFC, 0xFF, 0xFF,
								       0xFF, 0xFF, 0x7F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x1F, 0x3F, 0x7F, 0xFF,
								       0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xC7, 0xC7, 0x87, 0x8F, 0x9F, 0x9F, 0xFF, 0xFF,
								       0xFF, 0xC1, 0xC0, 0xE0, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xFC, 0xFC, 0xFC, 0xFE, 0xFE,
								       0xFE, 0xFC, 0xFC, 0xF8, 0xF8, 0xF0, 0xE0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0,
								       0xE0, 0xF1, 0xFB, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F, 0x0F, 0x0F, 0x87, 0xE7, 0xFF, 0xFF,
								       0xFF, 0x1F, 0x1F, 0x3F, 0xF9, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xFD, 0xFF, 0xFF, 0xFF, 0xFF,
								       0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x0F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFE, 0xFF, 0xFF,
								       0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x7E, 0x3F, 0x3F, 0x0F, 0x1F, 0xFF, 0xFF,
								       0xFF, 0xFC, 0xF0, 0xE0, 0xF1, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xF0, 0x01, 0x01, 0x01, 0x01,
								       0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03,
								       0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
								       0x0F, 0x1F, 0x3F, 0x7F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x7F, 0x1F, 0x03, 0x00, 0x00, 0x00,
								       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static int
write_data(int fd, uint8_t data)
{
  int ret;
  uint8_t cmdbuff[1000] = {0};
  struct iic_msg write_cmd[1] = {
				 {
				  .slave = IICADDR << 1 | !IIC_M_RD,
				  .flags = !IIC_M_RD,
				  .len = sizeof (buffer),
				  .buf = buffer,
				 }, 
  };

  struct iic_rdwr_data cmd = {
			      .msgs =  write_cmd,
			      .nmsgs = 1,
  };

  ret=ioctl(fd, I2CRDWR, &cmd);
  printf("write_data ret:%d\n",ret);
  return 0;
}

static int
ssd1306_command(int fd, uint8_t data)
{
  uint8_t cmdbuff[12] = {0};
  struct iic_msg write_cmd[1] = {
				 {
				  .slave = IICADDR << 1 | !IIC_M_RD,
				  .flags = !IIC_M_RD,
				  .len = 2*sizeof (uint8_t),
				  .buf = cmdbuff,
				 }, 
  };

  struct iic_rdwr_data cmd = {
			      .msgs =  write_cmd,
			      .nmsgs = 1,
  };

  cmdbuff[0]=0;
  cmdbuff[1]=data;

  ioctl(fd, I2CRDWR, &cmd);
  return 0;
}

int main(int argc, char *argv[])
{
  int i;
  int fd;
  uint8_t cmdbuff[12] = {0};
  uint8_t buf[1]={0};
  uint8_t retbuf[1]={0};
  struct iic_msg write_cmd[2] = {
				 {
				  .slave = IICADDR << 1 | !IIC_M_RD,
				  .flags = !IIC_M_RD,
				  .len = sizeof (uint8_t),
				  .buf = cmdbuff,
				 }, 
				 {
				  .slave = IICADDR << 1 | IIC_M_RD,
				  .flags = IIC_M_RD,
				  .len = sizeof (uint8_t),
				  .buf = retbuf,
				 }, 
  };
  struct iic_rdwr_data cmd = {
			      .msgs =  write_cmd,
			      .nmsgs = 2,
  };
  if ((fd = open(IICBUS, O_RDWR)) == -1) {
    fprintf(stderr, "%d Error %s\n", __LINE__, strerror(errno));
    return 1;
  }

  /* Initialize */
  ssd1306_command(fd,SSD1306_DISPLAYOFF);
  ssd1306_command(fd,SSD1306_SETDISPLAYCLOCKDIV);
  ssd1306_command(fd,0x80);

  ssd1306_command(fd,SSD1306_SETMULTIPLEX);
  ssd1306_command(fd,SSD1306_LCDHEIGHT - 1);

  ssd1306_command(fd,SSD1306_SETDISPLAYOFFSET);
  ssd1306_command(fd,0x0);
  ssd1306_command(fd,SSD1306_SETSTARTLINE | 0x0);
  ssd1306_command(fd,SSD1306_CHARGEPUMP);

  ssd1306_command(fd,0x14);

  ssd1306_command(fd,SSD1306_MEMORYMODE);
  ssd1306_command(fd,0x00);
  ssd1306_command(fd,SSD1306_SEGREMAP | 0x1);
  ssd1306_command(fd,SSD1306_COMSCANDEC);

  ssd1306_command(fd,SSD1306_SETCOMPINS);
  ssd1306_command(fd,0x12);
  ssd1306_command(fd,SSD1306_SETCONTRAST);

  ssd1306_command(fd,0xCF);

  ssd1306_command(fd,SSD1306_SETPRECHARGE);

  ssd1306_command(fd,0xF1);

  ssd1306_command(fd,SSD1306_SETVCOMDETECT);
  ssd1306_command(fd,0x40);
  ssd1306_command(fd,SSD1306_DISPLAYALLON_RESUME);
  ssd1306_command(fd,SSD1306_NORMALDISPLAY);

  ssd1306_command(fd,SSD1306_DEACTIVATE_SCROLL);

  ssd1306_command(fd,SSD1306_DISPLAYON);
  sleep(1);
  /* end of init */


  /* display */
  ssd1306_command(fd,SSD1306_COLUMNADDR);

  ssd1306_command(fd,32);
  ssd1306_command(fd,32 + SSD1306_LCDWIDTH - 1);

  ssd1306_command(fd,SSD1306_PAGEADDR);
  ssd1306_command(fd,0);
  ssd1306_command(fd,(SSD1306_LCDHEIGHT / 8) - 1);

  write_data(fd,buffer[0]);

  close(fd);
  return 0;
}

